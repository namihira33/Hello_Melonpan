<!--  melonpan11.html 位置情報の検索が経過秒ごとに可能になった -->

<html>

<head>
     <meta charset="utf-8" />
     <script src="/socket.io/socket.io.js"></script>
     <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
     <script type="text/javascript">
          var map; /* Google Map インスタンス */
          var marker; /* marker のインスタンス */
          var num_str;
          var positions = []; /* 現在位置情報LatLng型の配列 */
          var sumdist = 0;
          var one_second = 1000; /* 1秒は1000ms */
          var today_lats = [];
          var today_lngs = [];
          var today_dists = [];

          var sum_calory = 0.0;

          function initMap() {
               map = new google.maps.Map(document.getElementById('map_canvas'), {
                    center: {
                         lat: 36.085824,
                         lng: 140.106081
                    },
                    zoom: 14
               });
          }
          /* 現在位置を取得 */
          function getCurrentPosition() {
               if (navigator.geolocation) {
                    /* 高精度に現在位置を取得したいとき */
                    /*var bHighAccuracy = document.getElementById('chxHighAccuracy').checked;
                    var PositionOptions = {
                         enableHighAccuracy: bHighAccuracy,
                         timeout: 5000,
                         maximumAge:Infinity
                    };*/

                    /* 現在位置取得 */
                    navigator.geolocation.getCurrentPosition(success_func, error_func);
               } else {
                    alert('Geolocation を利用できません');
               }
          }
          /* 成功したときの処理 -> 緯度・経度・時間を取得 */
          function success_func(position) {
              var socket = io.connect();
              var inf_str = '';

              socket.on('greeting', function(data, fn) {
                console.log(data.message);
              });
               /* 取得情報の整理 */
               var lat = position.coords.latitude;
               var lng = position.coords.longitude;

               var test_origin = new google.maps.LatLng(36.098174, 140.100769);
               var test_destination = new google.maps.LatLng(36.097940, 140.100827);

               /* LatLng型の場合、LatLng.lat() や LatLng.lng()でそれぞれの数値を取ってこれる */
               var YourPosition = new google.maps.LatLng(lat, lng);
               var now = new Date(position.timestamp); // 取得時間
               now_str = now.getFullYear() + '/' + (now.getMonth() + 1) + '/' + now.getDate() ;

               /* 前位置にあったマーカーを消去 */
               function deleteMakers() {
                    if (marker != null) {
                         marker.setMap(null);
                    }
                    marker = null;
               }

               deleteMakers();


               // 現在位置にマーカーを立てる -> 位置を決めて、インスタンスを作れば○
               marker = new google.maps.Marker({
                    position: YourPosition,
                    map: map,
                    title: "You are here.",
                    icon: new google.maps.MarkerImage(
                     'cycle.png',
                     new google.maps.Size(80,50),
                    new google.maps.Point(0,0),
                  ),
               });
               map.setCenter(YourPosition);
               var win_options = {
                    content: '<b>現在位置</b><br />緯度：' + YourPosition.lat() + '<br />経度：' + YourPosition.lng() +
                         '<br />取得時間：' + now_str + '<br />' + sumdist + 'm'
               };
            
              /* 送信用の情報を作成 -> 送信 */
              var info = YourPosition.lat() + ',' + YourPosition.lng() + ',' + now_str +',' + sumdist
//              socket.emit('info',info);

               /* デバッグ用のinfowindow 
               var infoWindow = new google.maps.InfoWindow(win_options);
               infoWindow.open(map, marker); */

               positions.push(YourPosition);

               /* 線を引く := positionsに入っている配列の緯度経度を全部結ぶ */
               lines = new google.maps.Polyline({
                    path: positions,
                    strokeColor: "FF0000",
                    strokeOpacity: .7,
                    strokeWeight: 7
               });

               lines.setMap(map);

               //             var heading = position.coords.heading ;             // 0=北、90=東、180=南、270=西 ->向いている時期
               //               var speed = position.coords.speed ;               // 速さは機能していないみたいです。

               /* 円の描き方 */
                 var Circle = new google.maps.Circle({
                  strokeColor: '#FF0000',
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: '#FF0000',
                  fillOpacity: 0.35,
                  map: map,
                  center: YourPosition,
                  radius: 10
                }); 

               if (positions.length - 1 > 0) {
                    var originA = positions[positions.length - 2];
               } else {
                    var originA = YourPosition;
               }

               /* place(目的地:YourPosition,出発地:originA) -> 距離取得 */
               place(YourPosition, originA);
               function place(YourPosition, originA) {

                    /* 距離取得 */
                    var service = new google.maps.DistanceMatrixService();
                    service.getDistanceMatrix({
                         origins: [originA],
                         destinations: [YourPosition],
                         travelMode: 'WALKING',
                         unitSystem: google.maps.UnitSystem.METRIC,
                         avoidHighways: true,
                         avoidTolls: true,
                    }, callback);

                    function callback(response, status) {
                         //距離
                         distance = response['rows'][0]['elements'][0]['distance']['value'];
                         calc_cal(distance);

                         document.getElementById('dist').innerHTML = 'これだけ漕いだ : ' + sumdist + 'm';
                         document.getElementById('dist').innerHTML += '\n 速さはこれだけ : ' + Number.parseFloat (distance / 10 *3600/1000) + 'km/h = ' + distance / 10 * 60 + 'm/min = ' + distance / (10*one_second) + 'm/s';

                         sumdist += distance;
                        var info = YourPosition.lat() + ',' + YourPosition.lng() + ',' + now_str +',' + distance;
                         socket.emit('info',info);

                    }
               }
          }

          function error_func(errorinfo) {
               /* errorinfoはエラー情報を保持しています */
               var errorcode = errorinfo.code;
               var errmessage = errorinfo.message;
               switch (errorcode) {
                    case errorinfo.PERMISSION_DENIED: // 1:PERMISSION_DENIED:
                         alert('このページにはアクセス許可がないため、位置情報の取得に失敗しました。\nエラーメッセージ：' + errmessage);
                         break;
                    case errorinfo.POSITION_UNAVAILABLE: // 2:POSITION_UNAVAILABLE:
                         alert('少なくともひとつの位置情報ソースが内部的なエラーを返したため、位置情報の取得に失敗しました。\nエラーメッセージ：' + errmessage);
                         break;
                    case errorinfo.TIMEOUT: // 3:TIMEOUT:
                         alert('指定された制限時間内に位置情報を取得することができませんでした。\nエラーメッセージ：' + errmessage);
                         break;
               }
          }


          function Calc() {
               this.calory = 0;
               this.body = 58;
               this.v = 0;
               this.time = 10;
               this.calorycalc = function () {
                    this.calory = mets(this.v) * this.body * time/3600 * 1.05;
               };
               this.vcalc = function (d) {
                    time = 10;
                    this.v = d / time;
               };
          }


          function calc_cal(dist){
               var c = new Calc();
               c.v = dist/(10*one_second) * 3600/1000;
               c.vcalc(dist);
               c.calorycalc();

               sum_calory += c.calory;

               document.getElementById('speed').innerHTML = '速度 :' + c.v + 'km/h';
               document.getElementById('calory').innerHTML = '消費カロリー : ' + sum_calory + 'kcal';
          }
       
          function call_cal(dist){
          var c = new Calc();
               c.v = dist/(10*one_second) * 3600/1000;
               c.vcalc(dist);
               c.calorycalc();
          
              return c.calory;
        }


          // 計算機構
/*               var newData = []
                var item = []
              function calc_all() {
               const fs = require('fs');
               const csvSync = require('csv-parse/lib/sync'); // requiring sync module
               let text = fs.readFileSync("test.csv", 'utf-8');
               newData = csvSync(text);

               console.log('newDataはありますか？');
               console.log(newData);
               for (var i = 0; i < newData.length - 1; i++) {
                    var r = 6378.137 * 1000;
                    var x1 = newData[i][0];
                    var x2 = newData[i + 1][0];
                    var y1 = newData[i][1];
                    var y2 = newData[i + 1][1];
                    var d = r * Math.acos(Math.sin(y1) * Math.sin(y2) + Math.cos(y1) * Math.cos(y2) * Math.cos(x2 -
                    x1));
                    var time = 0.5;
                    var c = new Calc();
                    c.vcalc(d);
                    c.calorycalc();
                    console.log(c.v);
                    console.log(c.calory);
               }
          } */

          function mets(v) {
               if (v < 8900 / 60) {
                    return 3.5;
               }
               if (v < 15100 / 60) {
                    return 5.8;
               }
               if (v < 16100 / 60) {
                    return 6.3;
               }
               if (v < 19200 / 60) {
                    return 6.8;
               }
               if (v < 22400 / 60) {
                    return 8.0;
               }
               return 10.0;
          }
       
     </script>
</head>

<body>
     <div style="height:400px;100%" id="map_canvas"></div>
     <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDq9Cjb-9mTgMGfSUzliGr6_j5k2kBkac&callback=initMap"
          async="" defer=""></script>
     <br /><button class='btn btn-primary' type='button' onclick='setTimer();'>計測開始！</button>
     <button class='btn btn-primary' type='button' onclick='stopTimer();'>計測をやめる！</button>
     <button class='btn btn-primary' type='button' onclick='getTodayData();'>今日走った位置の描画</button>

     <div id="dist"></div>
     <div id="speed"></div>
     <div id="calory"></div>
     <div id="chartW"></div>

     <!-- <input type="checkbox" id="chxHighAccuracy" /><label for='chxHighAccuracy'> 高精度に位置を取得する </label> -->

     <script type="text/javascript">
          var intervalID;
          var second = 10;
          var query = '';

          function setTimer() {
               var k = 1000;

               intervalID = setInterval(getCurrentPosition, second * k);
          }

          function stopTimer() {
               var k = 1000;
               clearInterval(intervalID);
          }
       
          function drawChart() {
              var dt = new Date();
              var arr = [];
              for (i = 0;i<7;i++){
              var c = 0;
              var dtstr  = dt.toLocaleDateString()
              console.log(dtstr);
              if (c > 0){
                arr.push([dtstr,c]);
              }
              dt.setDate(dt.getDate() - 1);
            }
            var c = 0
            for (var j = 0;j < today_dists.length;j++){
              c+= call_cal(today_dists[j]);
            }
            arr.push([query,c]);
            arr.push(['2020/1/09',27]);
            arr.push(['Date', 'kcal']);
            arr.reverse();
            var data = google.visualization.arrayToDataTable(arr);
            var options = {
              title: 'kcal / days',
              hAxis: {title: 'Date',  titleTextStyle: {color: '#333'}},
              vAxis: {minValue: 0}
            };
            var chart = new google.visualization.ColumnChart(document.getElementById('chartW'));
            chart.draw(data, options);
          }
       
          function getTodayData(){
            var date = new Date();
            query = date.getFullYear() + '/' + (date.getMonth()+1) + '/' +date.getDate();
            console.log('↓' + query);
            var socket = io.connect();
                socket.on('greeting', function(data, fn) {
                console.log(data.message);
              });
                socket.emit('SQL_TODAY',query);
            
                socket.on('SQL_TODAY_LAT', function(data, fn) {
                console.log(data);
                today_lats = data.split(',');
                console.log(today_lats);
              });
                socket.on('SQL_TODAY_LNG', function(data, fn) {
                console.log(data);
                today_lngs = data.split(',');
                console.log(today_lngs);
              });
                socket.on('SQL_TODAY_DIST', function(data, fn) {
                console.log(data);
                today_dists = data.split(',');
                console.log(today_dists);
              });
            
              var today_positions = [];
            
              for(var i=0;i<today_lats.length;i++){
                today_position = new google.maps.LatLng(today_lats[i],today_lngs[i]);
                today_positions.push(today_position);
              }
            for (var i=0;i<today_positions.length;i++){
              console.log(today_positions[i].lat());
              console.log(today_positions[i].lng());
            }
            
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            
            lines3 = new google.maps.Polyline({
                    path: today_positions,
                    strokeColor: "FF0000",
                    strokeOpacity: .7,
                    strokeWeight: 7
               });

               lines3.setMap(map);
          }

     </script>

</body>

</html>
