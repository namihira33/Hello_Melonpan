<!--  melonpan11.html 位置情報の検索が経過秒ごとに可能になった -->

<html>

<head>
     <meta charset="utf-8" />
     <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
     <script type="text/javascript">
          var map; /* Google Map インスタンス */
          var marker; /* marker のインスタンス */
          var num_str;
          var positions = []; /* 現在位置情報LatLng型の配列 */
          var sumdist = 0;
          var one_second = 1000;

          var sum_calory = 0.0;

          function initMap() {
               map = new google.maps.Map(document.getElementById('map_canvas'), {
                    center: {
                         lat: 36.085824,
                         lng: 140.106081
                    },
                    zoom: 14
               });
          }
          /* 現在位置を取得 */
          function getCurrentPosition() {
               if (navigator.geolocation) {
                    /* 高精度に現在位置を取得したいとき */
                    /*var bHighAccuracy = document.getElementById('chxHighAccuracy').checked;
                    var PositionOptions = {
                         enableHighAccuracy: bHighAccuracy,
                         timeout: 5000,
                         maximumAge:Infinity
                    };*/

                    /* 現在位置取得 */
                    navigator.geolocation.getCurrentPosition(success_func, error_func);
               } else {
                    alert('Geolocation を利用できません');
               }
          }
          /* 成功したときの処理 -> 緯度・経度・時間を取得 */
          function success_func(position) {
               /* 取得情報の整理 */
               var lat = position.coords.latitude;
               var lng = position.coords.longitude;

               var test_origin = new google.maps.LatLng(36.098174, 140.100769);
               var test_destination = new google.maps.LatLng(36.097940, 140.100827);

               /* LatLng型の場合、LatLng.lat() や LatLng.lng()でそれぞれの数値を取ってこれる */
               var YourPosition = new google.maps.LatLng(lat, lng);
               var now = new Date(position.timestamp); // 取得時間
               now_str = now.getFullYear() + "年" + (now.getMonth() + 1) + "月" + now.getDate() + "日" +
                    (now.getHours() + "時" + now.getMinutes() + "分" + now.getSeconds() + "秒");

               /* 前位置にあったマーカーを消去 */
               function deleteMakers() {
                    if (marker != null) {
                         marker.setMap(null);
                    }
                    marker = null;
               }

               deleteMakers();


               // 現在位置にマーカーを立てる -> 位置を決めて、インスタンスを作れば○
               marker = new google.maps.Marker({
                    position: YourPosition,
                    map: map,
                    title: "You are here."
               });
               map.setCenter(YourPosition);
               var win_options = {
                    content: '<b>現在位置</b><br />緯度：' + YourPosition.lat() + '<br />経度：' + YourPosition.lng() +
                         '<br />取得時間：' + now_str + '<br />' + sumdist + 'm'
               };

               /* デバッグ用のinfowindow */
               var infoWindow = new google.maps.InfoWindow(win_options);
               infoWindow.open(map, marker);

               positions.push(YourPosition);

               /* 線を引く := positionsに入っている配列の緯度経度を全部結ぶ */
               lines = new google.maps.Polyline({
                    path: positions,
                    strokeColor: "FF0000",
                    strokeOpacity: .7,
                    strokeWeight: 7
               });

               lines.setMap(map);

               //             var heading = position.coords.heading ;             // 0=北、90=東、180=南、270=西 ->向いている時期
               //               var speed = position.coords.speed ;               // 速さは機能していないみたいです。

               /* 円の描き方 */
               /*
                 var Circle = new google.maps.Circle({
                  strokeColor: '#FF0000',
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: '#FF0000',
                  fillOpacity: 0.35,
                  map: map,
                  center: YourPosition,
                  radius: accuracy
                }); */

               if (positions.length - 1 > 0) {
                    var originA = positions[positions.length - 2];
               } else {
                    var originA = YourPosition;
               }

               /* place(目的地:YourPosition,出発地:originA) -> 距離取得 */
               place(YourPosition, originA);

               calc_cal(distance);

               function place(YourPosition, originA) {

                    /* 距離取得 */
                    var service = new google.maps.DistanceMatrixService();
                    service.getDistanceMatrix({
                         origins: [originA],
                         destinations: [YourPosition],
                         travelMode: 'WALKING',
                         unitSystem: google.maps.UnitSystem.METRIC,
                         avoidHighways: true,
                         avoidTolls: true,
                    }, callback);

                    function callback(response, status) {
                         //距離
                         distance = response['rows'][0]['elements'][0]['distance']['value'];

                         document.getElementById('dist').innerHTML = 'これだけ漕いだ : ' + sumdist + 'm';
                         document.getElementById('dist').innerHTML += '\n 速さはこれだけ : ' + Number.parseFloat (distance / (10*one_second) *3600/1000) + 'km/h = ' + distance / (10*one_second) * 60 + 'm/min = ' + distance / (10*one_second) + 'm/s';

                         sumdist += distance;

                    }
               }
          }

          function error_func(errorinfo) {
               /* errorinfoはエラー情報を保持しています */
               var errorcode = errorinfo.code;
               var errmessage = errorinfo.message;
               switch (errorcode) {
                    case errorinfo.PERMISSION_DENIED: // 1:PERMISSION_DENIED:
                         alert('このページにはアクセス許可がないため、位置情報の取得に失敗しました。\nエラーメッセージ：' + errmessage);
                         break;
                    case errorinfo.POSITION_UNAVAILABLE: // 2:POSITION_UNAVAILABLE:
                         alert('少なくともひとつの位置情報ソースが内部的なエラーを返したため、位置情報の取得に失敗しました。\nエラーメッセージ：' + errmessage);
                         break;
                    case errorinfo.TIMEOUT: // 3:TIMEOUT:
                         alert('指定された制限時間内に位置情報を取得することができませんでした。\nエラーメッセージ：' + errmessage);
                         break;
               }
          }


          function Calc() {
               this.calory = 0;
               this.body = 58;
               this.v = 0;
               this.time = 10;
               this.calorycalc = function () {
                    this.calory = mets(this.v) * this.body * time/3600 * 1.05;
               };
               this.vcalc = function (d) {
                    time = 0.5;
                    this.v = d / time;
               };
          }


          function calc_cal(dist){
               var c = new Calc();
               c.v = dist/(10*one_second) * 3600/1000;
               c.vcalc(dist);
               c.calorycalc();

               sum_calory += c.calory;

               document.getElementById('speed').innerHTML = '速度 :' + c.v + 'km/h';
               document.getElementById('calory').innerHTML = '消費カロリー : ' + sum_calory + 'kcal';
          }


          var newData = []
          var item = []

          // 計算機構
          function calc_all() {
               const fs = require('fs');
               const csvSync = require('csv-parse/lib/sync'); // requiring sync module
               let text = fs.readFileSync("test.csv", 'utf-8');
               newData = csvSync(text);

               console.log('newDataはありますか？');
               console.log(newData);
               for (var i = 0; i < newData.length - 1; i++) {
                    var r = 6378.137 * 1000;
                    var x1 = newData[i][0];
                    var x2 = newData[i + 1][0];
                    var y1 = newData[i][1];
                    var y2 = newData[i + 1][1];
                    var d = r * Math.acos(Math.sin(y1) * Math.sin(y2) + Math.cos(y1) * Math.cos(y2) * Math.cos(x2 -
                    x1));
                    var time = 0.5;
                    var c = new Calc();
                    c.vcalc(d);
                    c.calorycalc();
                    console.log(c.v);
                    console.log(c.calory);
               }
          }

          function mets(v) {
               if (v < 8900 / 60) {
                    return 3.5;
               }
               if (v < 15100 / 60) {
                    return 5.8;
               }
               if (v < 16100 / 60) {
                    return 6.3;
               }
               if (v < 19200 / 60) {
                    return 6.8;
               }
               if (v < 22400 / 60) {
                    return 8.0;
               }
               return 10.0;
          }

          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(drawChart);
          function drawChart() {
            var data = google.visualization.arrayToDataTable([
              ['Year', 'カロリー'],
              ['1/1',  100],
              ['1/2',  117],
              ['1/3',  660],
              ['1/4',  103],
              ['1/5',  103],
              ['1/6',  103],
              ['1/7',  103]
            ]);

            var options = {
              title: 'Company Performance',
              hAxis: {title: 'Year',  titleTextStyle: {color: '#333'}},
              vAxis: {minValue: 0}
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('chartW'));
            chart.draw(data, options);
          }

     </script>
</head>

<body>
     <div style="height:400px;100%" id="map_canvas"></div>
     <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDq9Cjb-9mTgMGfSUzliGr6_j5k2kBkac&callback=initMap"
          async="" defer=""></script>
     <br /><button class='btn btn-primary' type='button' onclick='setTimer();'>計測開始！</button>
     <button class='btn btn-primary' type='button' onclick='stopTimer();'>計測をやめる！</button>

     <div id="dist"></div>
     <div id="speed"></div>
     <div id="calory"></div>
     <div id="chartW"></div>

     <!-- <input type="checkbox" id="chxHighAccuracy" /><label for='chxHighAccuracy'> 高精度に位置を取得する </label> -->

     <script type="text/javascript">
          var intervalID;
          var second = 10;

          function setTimer() {
               var k = 1000;

               intervalID = setInterval(getCurrentPosition, second * k);
          }

          function stopTimer() {
               var k = 1000;
               clearInterval(intervalID);
          }
     </script>

</body>

</html>
